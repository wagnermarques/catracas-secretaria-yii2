server {
    listen 80;
    server_name localhost;
    
    # Root directory for the server
    root /var/www/html;
    index index.php;
    charset utf-8;

    # Main location for serving static files from root
    location / {
        try_files $uri $uri/ =404;
    }

    # Yii2 application in subfolder
    location /catracassecretaria {
        # Remove the /catracassecretaria prefix and set the correct root
        alias /var/www/html/src-projects/catracassecretaria/web;
        
        # Try to serve static files first, then pass to PHP
        try_files $uri $uri/ @catracassecretaria;
        
        # Handle index requests
        location = /catracassecretaria {
            return 301 /catracassecretaria/;
        }
        
	location = /catracassecretaria/ {
            try_files /index.php =404;
            fastcgi_pass eteczlcatracas-php-fpm:9000;
            fastcgi_param SCRIPT_FILENAME /var/www/html/src-projects/catracassecretaria/web/index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_NAME /catracassecretaria/index.php;
            fastcgi_read_timeout 300;
        }
        
	# Handle PHP files within the Yii2 app
        location ~ ^/catracassecretaria/(.+\.php)$ {
            try_files $uri =404;
            fastcgi_pass eteczlcatracas-php-fpm:9000;
            fastcgi_param SCRIPT_FILENAME /var/www/html/src-projects/catracassecretaria/web/$1;
            include fastcgi_params;
            fastcgi_param SCRIPT_NAME /catracassecretaria/$1;
            fastcgi_read_timeout 300;
        }

        # Cache static assets within the Yii2 app
        location ~ ^/catracassecretaria/assets/.*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
    }
    
    # Named location for Yii2 URL rewriting
    location @catracassecretaria {
        rewrite ^/catracassecretaria/(.*)$ /catracassecretaria/index.php?$query_string last;
    }
    
    # Handle the rewritten requests to index.php
    location = /catracassecretaria/index.php {
        fastcgi_pass eteczlcatracas-php-fpm:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/src-projects/catracassecretaria/web/index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_NAME /catracassecretaria/index.php;
        fastcgi_read_timeout 300;
    }
    
    # Block access to sensitive directories within the Yii2 app
    location ~ ^/catracassecretaria/\.(git|svn|ht) {
        deny all;
    }

    location ~ ^/catracassecretaria/(runtime|tests) {
        deny all;
    }
}
