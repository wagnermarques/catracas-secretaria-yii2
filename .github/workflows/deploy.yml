name: Deploy to Azure VM

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sanitize Inputs
        id: vars
        run: |
          # This trims leading/trailing whitespace and newlines
          CLEAN_USER=$(echo "${{ secrets.VM_SSH_USER }}" | xargs)
          CLEAN_HOST=$(echo "${{ secrets.VM_SSH_HOST }}" | xargs)
          echo "user=${CLEAN_USER}" >> $GITHUB_OUTPUT
          echo "host=${CLEAN_HOST}" >> $GITHUB_OUTPUT

      - name: Deploy to VM via SSH/Rsync
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VM_SSH_KEY }}
          ARGS: "-rlgoDzvc -i --delete"
          REMOTE_HOST: ${{ steps.vars.outputs.host }}
          REMOTE_USER: ${{ steps.vars.outputs.user }}
          TARGET: "/home/${{ steps.vars.outputs.user }}/catracas-secretaria-yii2"
          EXCLUDE: ".env,vendor/,runtime/,web/assets/,/web/assets/*,.git/,.github/,eteczlcatracas-db-data/,node_modules/"

      - name: Create .env file on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.vars.outputs.host }}
          username: ${{ steps.vars.outputs.user }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cat << 'EOF' > /home/${{ steps.vars.outputs.user }}/catracas-secretaria-yii2/.env
            ${{ secrets.ENV_FILE }}
            EOF

      - name: Create Firebase Key file on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.vars.outputs.host }}
          username: ${{ steps.vars.outputs.user }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            mkdir -p /home/${{ steps.vars.outputs.user }}/catracas-secretaria-yii2/firebase-keys
            cat << 'EOF' > /home/${{ steps.vars.outputs.user }}/catracas-secretaria-yii2/firebase-keys/catracase211-firebase-adminsdk-aus3a-1ddfcfff85.json
            ${{ secrets.FIREBASE_KEY_JSON }}
            EOF

      - name: Execute remote Docker commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.vars.outputs.host }}
          username: ${{ steps.vars.outputs.user }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /home/${{ steps.vars.outputs.user }}/catracas-secretaria-yii2
            # Force recreation of all containers to ensure fresh state
            docker compose down
            docker compose up -d --build
            
            # Check if all containers are actually running
            docker ps
            
            # Wait for MySQL to be ready
            echo "Waiting for database..."
            sleep 15
                        
            # Create a database backup before migrations
            docker exec eteczlcatracas-mysql mysqldump -uroot -p1234 eteczlcatracas_db > pre_migration_$(date +%Y%m%d_%H%M%S).sql
            
            # Install dependencies inside the PHP container
            docker exec eteczlcatracas-php-fpm composer install --no-dev --optimize-autoloader
            
            # Run database migrations
            docker exec eteczlcatracas-php-fpm php yii migrate --interactive=0
            
            # Ensure correct permissions for Yii runtime and assets
            docker exec eteczlcatracas-php-fpm chown -R www-data:www-data runtime web/assets
